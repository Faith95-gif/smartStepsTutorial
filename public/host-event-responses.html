<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Responses - Smart Steps Tutorial</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/host-dashboard.css">
    <link rel="stylesheet" href="/css/logo.css">
    <link rel="stylesheet" href="/css/host-event-responses.css">
</head>
<body>
    <header class="header">
        <nav class="navbar">
            <div class="nav-brand">
                <div class="logo"><img class="" src="img/steps_smart.png" alt=""></div>
                <span>Smart Steps Tutorial - Host</span>
            </div>
            <div class="nav-links">
                <a href="/host-dashboard" class="btn btn-outline">
                    <i class="fas fa-arrow-left"></i>
                    Back to Dashboard
                </a>
                <button id="logoutBtn" class="btn btn-outline">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </nav>
    </header>

    <main class="main">
        <div id="loadingContainer" class="text-center">
            <i class="fas fa-spinner fa-spin fa-3x text-primary"></i>
            <p class="mt-3">Loading event responses...</p>
        </div>

        <div id="responsesContainer" class="hidden">
            <div class="dashboard-header">
                <h1 class="dashboard-title">
                    <i class="fas fa-chart-bar"></i>
                    Event Responses
                </h1>
                <div id="eventInfo" class="dashboard-subtitle"></div>
                
                <div id="responseStats" class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalResponses">0</div>
                        <div class="stat-label">Total Responses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="averageScore">0%</div>
                        <div class="stat-label">Average Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="highestScore">0%</div>
                        <div class="stat-label">Highest Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="averageTime">0</div>
                        <div class="stat-label">Average Time</div>
                    </div>
                </div>
            </div>

            <div class="quiz-container">
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="sortBy">Sort by:</label>
                        <select id="sortBy">
                            <option value="submittedAt">Submission Date</option>
                            <option value="score">Score (High to Low)</option>
                            <option value="name">Student Name</option>
                            <option value="timeSpent">Time Spent</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterScore">Min Score:</label>
                        <input type="number" id="filterScore" min="0" max="100" placeholder="%" style="width: 80px;">
                    </div>
                    <div class="filter-group">
                        <label for="searchStudent">Search Student:</label>
                        <input type="text" id="searchStudent" placeholder="Enter name or email" style="width: 200px;">
                    </div>
                    <div class="export-controls">
                        <button id="exportBtn" class="btn btn-primary">
                            <i class="fas fa-download"></i>
                            Export CSV
                        </button>
                    </div>
                </div>

                <h2 class="section-title">
                    <i class="fas fa-users"></i>
                    Student Responses
                </h2>
                
                <div id="responsesTable">
                    <!-- Responses table will be loaded here -->
                </div>
            </div>
        </div>

        <div id="errorContainer" class="quiz-container hidden">
            <div class="alert alert-error">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="errorMessage">Event responses not found or access denied.</span>
            </div>
            <div class="text-center">
                <a href="/host-dashboard" class="btn btn-primary">
                    <i class="fas fa-tachometer-alt"></i>
                    Back to Dashboard
                </a>
            </div>
        </div>
    </main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        let currentResponses = [];
        let currentEvent = null;
        
        checkAuthentication();
        
        const eventId = window.location.pathname.split('/').pop();
        console.log('Event ID:', eventId);
        
        if (!eventId || eventId === 'host-event-responses.html') {
            console.error('No valid event ID found');
            document.getElementById('loadingContainer').classList.add('hidden');
            document.getElementById('errorMessage').textContent = 'Invalid event ID';
            document.getElementById('errorContainer').classList.remove('hidden');
            return;
        }
        
        loadEventResponses();
        
        // Event listeners
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('sortBy').addEventListener('change', applyFilters);
        document.getElementById('filterScore').addEventListener('input', applyFilters);
        document.getElementById('searchStudent').addEventListener('input', applyFilters);
        document.getElementById('exportBtn').addEventListener('click', exportToCSV);

        async function checkAuthentication() {
            try {
                const response = await fetch('/api/host/verify', {
                    credentials: 'include'
                });
                if (!response.ok) {
                    console.log('Authentication failed, redirecting to login');
                    window.location.href = '/host-login';
                    return;
                }
                const data = await response.json();
                console.log('Host authenticated:', data);
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = '/host-login';
            }
        }

        async function loadEventResponses() {
            try {
                console.log('Fetching event responses for ID:', eventId);
                const response = await fetch(`/api/host/events/${eventId}/responses`, {
                    credentials: 'include'
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: `HTTP ${response.status}` }));
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('Event responses loaded:', data);
                
                currentEvent = data.event;
                currentResponses = data.responses || [];
                
                document.getElementById('loadingContainer').classList.add('hidden');
                displayEventResponses(data);
                
            } catch (error) {
                console.error('Error loading event responses:', error);
                document.getElementById('loadingContainer').classList.add('hidden');
                document.getElementById('errorMessage').textContent = error.message || 'Failed to load event responses';
                document.getElementById('errorContainer').classList.remove('hidden');
            }
        }

        function displayEventResponses(data) {
            document.getElementById('responsesContainer').classList.remove('hidden');
            
            // Update event information
            const statusBadge = getStatusBadge(data.event.status);
            const deadlineInfo = new Date(data.event.deadline) > new Date() ? 
                `Deadline: ${new Date(data.event.deadline).toLocaleString()}` :
                '<span style="color: red;">EXPIRED</span>';
            
            document.getElementById('eventInfo').innerHTML = `
                <div style="margin-bottom: 15px;">
                    <strong style="font-size: 1.2em;">${data.event.title}</strong>
                    ${statusBadge}
                </div>
                <div style="margin-bottom: 10px;">
                    <i class="fas fa-clock"></i> Time Limit: ${data.event.timeLimit} minutes |
                    <i class="fas fa-question"></i> Total Questions: ${data.event.totalQuestions} |
                    <i class="fas fa-calendar"></i> ${deadlineInfo}
                </div>
                ${data.event.description ? `<div style="font-style: italic; color: #6c757d;">${data.event.description}</div>` : ''}
            `;
            
            calculateAndDisplayStats(data.responses);
            displayResponsesTable(data.responses);
        }

        function getStatusBadge(status) {
            const badges = {
                'active': '<span style="background: #ffc107; color: #333; padding: 4px 8px; border-radius: 4px; margin-left: 10px;">Active</span>',
                'completed': '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; margin-left: 10px;">Completed</span>',
                'published': '<span style="background: #007bff; color: white; padding: 4px 8px; border-radius: 4px; margin-left: 10px;">Published</span>'
            };
            return badges[status] || '';
        }

        function calculateAndDisplayStats(responses) {
            const totalResponses = responses.length;
            
            let totalScore = 0;
            let totalTime = 0;
            let highestScore = 0;
            
            responses.forEach(response => {
                const percentage = response.percentage || Math.round((response.totalScore / response.totalQuestions) * 100);
                totalScore += percentage;
                totalTime += response.timeSpent || 0;
                if (percentage > highestScore) {
                    highestScore = percentage;
                }
            });
            
            const averageScore = totalResponses > 0 ? Math.round(totalScore / totalResponses) : 0;
            const averageTime = totalResponses > 0 ? Math.round(totalTime / totalResponses) : 0;
            
            // Update statistics
            document.getElementById('totalResponses').textContent = totalResponses;
            document.getElementById('averageScore').textContent = averageScore + '%';
            document.getElementById('highestScore').textContent = highestScore + '%';
            document.getElementById('averageTime').textContent = formatTime(averageTime);
        }

        function displayResponsesTable(responses) {
            const container = document.getElementById('responsesTable');
            
            if (responses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>No Student Responses</h3>
                        <p>No students have taken this JAMB Mock exam yet.</p>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-user"></i> Student Name</th>
                                <th><i class="fas fa-envelope"></i> Email</th>
                                <th><i class="fas fa-trophy"></i> Total Score</th>
                                <th><i class="fas fa-percentage"></i> Percentage</th>
                                <th><i class="fas fa-clock"></i> Time Spent</th>
                                <th><i class="fas fa-calendar"></i> Submitted</th>
                                <th><i class="fas fa-chart-line"></i> Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${responses.map(response => {
                                const percentage = response.percentage || Math.round((response.totalScore / response.totalQuestions) * 100);
                                return `
                                    <tr data-response-id="${response._id}">
                                        <td><strong>${response.studentName}</strong></td>
                                        <td>${response.studentEmail}</td>
                                        <td>${response.totalScore}/${response.totalQuestions}</td>
                                        <td>
                                            <span class="text-${getScoreColor(percentage)}">
                                                ${percentage}%
                                            </span>
                                        </td>
                                        <td>${formatTime(response.timeSpent || 0)}</td>
                                        <td>${new Date(response.submittedAt).toLocaleString()}</td>
                                        <td>
                                            <button class="btn btn-outline btn-small" onclick="toggleSubjectBreakdown('${response._id}')">
                                                <i class="fas fa-chart-pie"></i>
                                                View Breakdown
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHTML;
        }

        function applyFilters() {
            const sortBy = document.getElementById('sortBy').value;
            const minScore = parseInt(document.getElementById('filterScore').value) || 0;
            const searchTerm = document.getElementById('searchStudent').value.toLowerCase().trim();
            
            let filteredResponses = [...currentResponses];
            
            // Apply search filter
            if (searchTerm) {
                filteredResponses = filteredResponses.filter(response => 
                    response.studentName.toLowerCase().includes(searchTerm) ||
                    response.studentEmail.toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply score filter
            filteredResponses = filteredResponses.filter(response => {
                const percentage = response.percentage || Math.round((response.totalScore / response.totalQuestions) * 100);
                return percentage >= minScore;
            });
            
            // Apply sorting
            filteredResponses.sort((a, b) => {
                switch (sortBy) {
                    case 'score':
                        const aPerc = a.percentage || Math.round((a.totalScore / a.totalQuestions) * 100);
                        const bPerc = b.percentage || Math.round((b.totalScore / b.totalQuestions) * 100);
                        return bPerc - aPerc;
                    case 'name':
                        return a.studentName.localeCompare(b.studentName);
                    case 'timeSpent':
                        return (b.timeSpent || 0) - (a.timeSpent || 0);
                    case 'submittedAt':
                    default:
                        return new Date(b.submittedAt) - new Date(a.submittedAt);
                }
            });
            
            displayResponsesTable(filteredResponses);
        }

        function formatTime(seconds) {
            if (seconds === 0) return 'N/A';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
            }
        }

        function getScoreColor(percentage) {
            if (percentage >= 70) return 'success';
            if (percentage >= 50) return 'warning';
            return 'error';
        }

        window.toggleSubjectBreakdown = async function(responseId) {
            const responseRow = document.querySelector(`tr[data-response-id="${responseId}"]`);
            const existingBreakdown = responseRow.nextElementSibling;
            
            if (existingBreakdown && existingBreakdown.classList.contains('breakdown-row')) {
                // Remove existing breakdown
                existingBreakdown.remove();
                return;
            }
            
            try {
                // Fetch detailed breakdown
                const response = await fetch(`/api/host/response/${responseId}/breakdown`, {
                    credentials: 'include'
                });
                if (!response.ok) {
                    throw new Error('Failed to fetch breakdown');
                }
                
                const breakdown = await response.json();
                
                // Create breakdown row
                const breakdownRow = document.createElement('tr');
                breakdownRow.classList.add('breakdown-row');
                
                const breakdownCell = document.createElement('td');
                breakdownCell.colSpan = 7;
                
                breakdownCell.innerHTML = `
                    <div class="breakdown-content">
                        <h4 style="margin-bottom: 15px;">
                            <i class="fas fa-user"></i> ${breakdown.studentName} - Subject Breakdown
                        </h4>
                        <div class="subject-breakdown">
                            ${breakdown.subjectBreakdown.map(subject => `
                                <div class="subject-score">
                                    <div class="subject-name">${subject.subject}</div>
                                    <div class="score-percentage text-${getScoreColor(subject.percentage)}">
                                        ${subject.percentage}%
                                    </div>
                                    <div class="score-details">
                                        ${subject.score}/${subject.totalQuestions} correct<br>
                                        Wrong: ${subject.wrongAnswers} | Unanswered: ${subject.unanswered}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e9ecef; font-size: 0.9em; color: #6c757d;">
                            <strong>Overall:</strong> ${breakdown.totalScore}/${breakdown.totalQuestions} 
                            (${Math.round((breakdown.totalScore / breakdown.totalQuestions) * 100)}%) | 
                            <strong>Time:</strong> ${formatTime(breakdown.timeSpent)} | 
                            <strong>Submitted:</strong> ${new Date(breakdown.submittedAt).toLocaleString()}
                        </div>
                    </div>
                `;
                
                breakdownRow.appendChild(breakdownCell);
                responseRow.parentNode.insertBefore(breakdownRow, responseRow.nextSibling);
                
            } catch (error) {
                alert('Error loading breakdown: ' + error.message);
            }
        };

        function exportToCSV() {
            if (currentResponses.length === 0) {
                alert('No responses to export');
                return;
            }
            
            const headers = ['Student Name', 'Email', 'Total Score', 'Total Questions', 'Percentage', 'Time Spent (seconds)', 'Submitted At'];
            const csvContent = [
                headers.join(','),
                ...currentResponses.map(response => {
                    const percentage = response.percentage || Math.round((response.totalScore / response.totalQuestions) * 100);
                    return [
                        `"${response.studentName}"`,
                        `"${response.studentEmail}"`,
                        response.totalScore,
                        response.totalQuestions,
                        percentage,
                        response.timeSpent || 0,
                        `"${new Date(response.submittedAt).toISOString()}"`
                    ].join(',');
                })
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentEvent.title.replace(/[^a-z0-9]/gi, '_')}_responses.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        async function logout() {
            try {
                await fetch('/api/host/logout', { 
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = '/';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/';
            }
        }
    });
</script>
</body>
</html>